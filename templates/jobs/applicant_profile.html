{% extends "base.html" %}

{% block title %}{{ applicant.username }} - Application Details{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Back Button -->
        <a href="{{ url_for('jobs.my_applicants') }}" class="text-blue-600 hover:text-blue-800 font-semibold mb-6 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Back to Applicants
        </a>

        <!-- Profile Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="flex items-start space-x-6">
                {% if applicant.profile_picture %}
                <img src="{{ applicant.profile_picture }}" alt="{{ applicant.username }}" 
                     class="w-32 h-32 rounded-full object-cover border-4 border-blue-500">
                {% else %}
                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center text-white font-bold text-4xl border-4 border-blue-500">
                    {{ applicant.username[0].upper() }}
                </div>
                {% endif %}
                
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-900">{{ applicant.username }}</h1>
                    <p class="text-gray-600 text-lg mt-1">{{ applicant.email }}</p>
                    
                    {% if applicant.phone %}
                    <p class="text-gray-600 mt-2"><i class="fas fa-phone mr-2 text-blue-600"></i>{{ applicant.phone }}</p>
                    {% endif %}
                    
                    {% if applicant.location %}
                    <p class="text-gray-600 mt-1"><i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>{{ applicant.location }}</p>
                    {% endif %}
                    
                    <div class="mt-4 text-sm text-gray-500">
                        Joined: {{ applicant.created_at[:10] if applicant.created_at else 'N/A' }}
                    </div>
                </div>
            </div>

            {% if applicant.bio %}
            <div class="mt-6 border-t border-gray-200 pt-6">
                <h3 class="font-bold text-gray-900 mb-2">About</h3>
                <p class="text-gray-600">{{ applicant.bio }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Resume Section -->
        {% if applicant.resume_data %}
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Resume</h2>

        {% if applicant.resume_data.fullName %}
            <p class="text-lg font-semibold text-gray-800 mb-2">{{ applicant.resume_data.fullName }}</p>
        {% endif %}
        {% if applicant.resume_data.email %}
            <p class="text-gray-600 mb-1"><i class="fas fa-envelope mr-2 text-blue-600"></i>{{ applicant.resume_data.email }}</p>
        {% endif %}
        {% if applicant.resume_data.phone %}
            <p class="text-gray-600 mb-4"><i class="fas fa-phone mr-2 text-blue-600"></i>{{ applicant.resume_data.phone }}</p>
        {% endif %}

        {% if applicant.resume_data.interests %}
            <div class="mt-4">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Interests</h3>
            <ul class="list-disc list-inside text-gray-700">
                {% for item in applicant.resume_data.interests %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            </div>
        {% endif %}

        {% if applicant.resume_data.skills %}
            <div class="mt-4">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Skills</h3>
            <div class="flex flex-wrap gap-2">
                {% for skill in applicant.resume_data.skills %}
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">{{ skill }}</span>
                {% endfor %}
            </div>
            </div>
        {% endif %}

        {% if applicant.resume_data.education %}
            <div class="mt-4">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Education</h3>
            <ul class="list-disc list-inside text-gray-700">
                {% for item in applicant.resume_data.education %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            </div>
        {% endif %}

        {% if applicant.resume_data.experience %}
            <div class="mt-4">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Experience</h3>
            <ul class="list-disc list-inside text-gray-700">
                {% for item in applicant.resume_data.experience %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            </div>
        {% endif %}

        {% if applicant.resume_data.extracurriculars %}
            <div class="mt-4">
            <h3 class="font-bold text-lg text-gray-900 mb-2">Extracurriculars</h3>
            <ul class="list-disc list-inside text-gray-700">
                {% for item in applicant.resume_data.extracurriculars %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            </div>
        {% endif %}
        </div>
        {% else %}
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8 mb-6">
        <h2 class="text-2xl font-bold text-yellow-900 mb-2">Resume</h2>
        <p class="text-yellow-800">No resume data has been submitted by this applicant yet.</p>
        </div>
        {% endif %}
        <!-- CV File Section -->
        {% if application.cv_file %}
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">CV Attachment</h2>
            
            <div class="bg-gray-50 border-2 border-dashed border-blue-300 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file-pdf text-red-500 text-3xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-900">{{ application.cv_file.split('/')[-1] }}</p>
                            <p class="text-sm text-gray-600">CV Document</p>
                        </div>
                    </div>
                    <a href="{{ url_for('jobs.download_cv', application_id=application.id) }}" 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center">
                        <i class="fas fa-download mr-2"></i>Download
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Application Details -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Application Details</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Position Applied For</label>
                    <p class="text-gray-900 text-lg">{{ application.job_title }}</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Application Date</label>
                    <p class="text-gray-900">{{ application.created_at[:10] if application.created_at else 'N/A' }}</p>
                </div>
                
                {% if application.status %}
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    {% if application.status == 'accepted' %}
                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        ✓ Accepted
                    </span>
                    {% elif application.status == 'rejected' %}
                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        ✗ Rejected
                    </span>
                    {% else %}
                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                        ⏳ Pending Review
                    </span>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if application.cover_letter %}
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cover Letter</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-gray-700 whitespace-pre-wrap break-words">
                        {{ application.cover_letter }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        {% if application.status != 'accepted' and application.status != 'rejected' %}
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Application Actions</h3>
            
            <div class="space-y-4">
                <!-- Accept Button -->
                <form method="POST" action="{{ url_for('jobs.accept_applicant', application_id=application.id) }}" class="inline-block">
                    {{ csrf_token() }}
                    <button type="submit" onclick="return confirm('Accept this application?')" 
                            class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-check mr-2"></i>Accept Application
                    </button>
                </form>
                
                <!-- Reject Button -->
                <button onclick="showRejectModal()" 
                        class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-times mr-2"></i>Reject Application
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Message/Chat Section -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Contact Applicant</h3>
            
            <a href="{{ url_for('chat.contextual_chat_view', recipient_id=applicant.id, context_type='application', context_id=application.id, context_title=application.job_title) }}" 
               class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                <i class="fas fa-comments mr-2"></i>Open Chat
            </a>
            <p class="text-sm text-gray-600 mt-3">
                <i class="fas fa-info-circle mr-2"></i>Chat with {{ applicant.username }} about their application for <strong>{{ application.job_title }}</strong>
            </p>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Reject Application</h2>
        
        <form method="POST" action="{{ url_for('jobs.reject_applicant', application_id=application.id) }}">
            {{ csrf_token() }}
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Rejection Reason (Optional)</label>
                <textarea name="reason" rows="3" placeholder="Why are you rejecting this applicant?"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"></textarea>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="closeRejectModal()" 
                        class="flex-1 px-4 py-3 bg-gray-300 text-gray-900 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    Reject
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showRejectModal() {
    document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('rejectModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeRejectModal();
});
</script>
{% endblock %}
