{% extends "base.html" %}

{% block title %}Apply for {{ job.title }} - Catanduanes Connect{% endblock %}

{% block content %}
<style>
    /* AI Assistant Styles */
    .ai-assistant-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 15px;
    }

    .ai-circle {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        border: 3px solid white;
        font-size: 32px;
    }

    .ai-circle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }

    .ai-circle.thinking {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
    }

    .ai-bubble {
        background: white;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 15px 20px;
        max-width: 350px;
        max-height: 400px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.4s ease-out;
        position: relative;
    }

    .ai-bubble::after {
        content: '';
        position: absolute;
        bottom: -10px;
        right: 20px;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 0px solid transparent;
        border-top: 10px solid #667eea;
    }

    .ai-bubble.error {
        border-color: #ff6b6b;
    }

    .ai-bubble.error::after {
        border-top-color: #ff6b6b;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .ai-bubble-title {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
    }

    .ai-bubble-content {
        color: #333;
        font-size: 13px;
        line-height: 1.5;
        overflow-y: auto;
        padding-right: 8px;
        flex: 1;
        min-height: 0;
    }

    .ai-bubble-content::-webkit-scrollbar {
        width: 6px;
    }

    .ai-bubble-content::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 10px;
    }

    .ai-bubble-content::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    .ai-bubble-content::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    .ai-bubble-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-shrink: 0;
    }

    .ai-action-btn {
        padding: 6px 12px;
        border: 1px solid #667eea;
        border-radius: 4px;
        background: white;
        color: #667eea;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .ai-action-btn:hover {
        background: #667eea;
        color: white;
    }

    .ai-action-btn.primary {
        background: #667eea;
        color: white;
    }

    .ai-action-btn.primary:hover {
        background: #5568d3;
    }

    .language-btn {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        color: #333;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .language-btn:hover {
        background: #f0f0f0;
        border-color: #667eea;
    }

    .language-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .ai-close-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        margin-left: 8px;
    }

    .ai-close-btn:hover {
        color: #333;
    }

    .ai-suggestion-list {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
    }

    .ai-suggestion-list li {
        padding: 8px 0 8px 20px;
        position: relative;
        color: #555;
        font-size: 13px;
    }

    .ai-suggestion-list li:before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: #28a745;
        font-weight: bold;
    }

    .ai-suggestion-list li.warning:before {
        content: '‚ö†';
        color: #ffc107;
    }

    @media only screen and (max-width: 768px) {
        .ai-assistant-container {
            bottom: 20px;
            right: 20px;
        }

        .ai-circle {
            width: 60px;
            height: 60px;
            font-size: 28px;
        }

        .ai-bubble {
            max-width: 280px;
        }
    }

    /* Hide the base.html chat elements on this page */
    .fixed.bottom-6.right-6.z-50 {
        display: none !important;
    }

    #chat-modal {
        display: none !important;
    }
</style>
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-file-alt text-blue-600 mr-3"></i>Submit Application
                    </h1>
                    <p class="text-lg text-gray-600">
                        Apply for this exciting opportunity
                    </p>
                </div>
            </div>
        </div>

        <!-- Job Summary Card -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <!-- Job Header -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-8 py-6">
                <h2 class="text-3xl font-bold text-white mb-2">{{ job.title }}</h2>
                <p class="text-blue-100 flex items-center">
                    <i class="fas fa-building mr-2"></i>{{ job.business_name }}
                </p>
            </div>

            <!-- Job Details -->
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border-l-4 border-blue-500 pl-4">
                        <p class="text-sm text-gray-600 font-semibold mb-1">Employment Type</p>
                        <p class="text-lg font-bold text-gray-900">{{ job.type_display }}</p>
                    </div>
                    <div class="border-l-4 border-green-500 pl-4">
                        <p class="text-sm text-gray-600 font-semibold mb-1">Salary Range</p>
                        <p class="text-lg font-bold text-gray-900">{{ job.salary_range_display }}</p>
                    </div>
                    <div class="border-l-4 border-purple-500 pl-4">
                        <p class="text-sm text-gray-600 font-semibold mb-1">Work Setup</p>
                        <p class="text-lg font-bold text-gray-900">{{ job.setup_display }}</p>
                    </div>
                    <div class="border-l-4 border-orange-500 pl-4">
                        <p class="text-sm text-gray-600 font-semibold mb-1">Location</p>
                        <p class="text-lg font-bold text-gray-900">{{ job.location }}</p>
                    </div>
                </div>
                
                <!-- Description -->
                <div class="pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-600 font-semibold mb-3">Job Description</p>
                    <p class="text-gray-700 leading-relaxed">{{ job.description or 'No description provided' }}</p>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="success-message hidden fixed top-4 right-4 bg-green-100 border border-green-400 text-green-800 px-6 py-4 rounded-lg shadow-lg z-50 max-w-md" id="successMessage">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-3 text-xl"></i>
                <div id="successText">Application submitted successfully! Redirecting...</div>
            </div>
        </div>

        <div class="error-message hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-800 px-6 py-4 rounded-lg shadow-lg z-50 max-w-md" id="errorMessage">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-3 text-xl"></i>
                <div id="errorText">An error occurred. Please try again.</div>
            </div>
        </div>

        <!-- Resume Info Banner -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-8">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-2xl mr-4 flex-shrink-0 mt-1"></i>
                <div>
                    <h4 class="text-lg font-bold text-gray-900 mb-2">Your Resume on File</h4>
                    <p class="text-gray-700 mb-3">
                        Your current resume from your profile will automatically be sent with this application. The business owner will be able to view both your resume and the CV you provide below.
                    </p>
                    <a href="{{ url_for('jobs.update_resume') }}" class="text-blue-600 hover:text-blue-800 font-semibold inline-flex items-center">
                        <i class="fas fa-edit mr-2"></i>Edit Your Resume
                    </a>
                </div>
            </div>
        </div>

        <!-- Application Form -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-500 to-blue-600 px-8 py-6">
                <h3 class="text-2xl font-bold text-white">
                    <i class="fas fa-pen mr-2"></i>Your Application
                </h3>
            </div>

            <div class="p-8">
                <form id="applicationForm" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <!-- Cover Letter -->
                    <div class="mb-8">
                        <label for="cover_letter" class="block text-lg font-bold text-gray-900 mb-3">
                            <i class="fas fa-envelope text-blue-600 mr-2"></i>Cover Letter <span class="text-red-500">*</span>
                        </label>
                        <textarea id="cover_letter" name="cover_letter" 
                                  placeholder="Tell us why you're interested in this position and what makes you a great fit..."
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 resize-none"
                                  rows="8"
                                  required></textarea>
                        <p class="mt-3 text-sm text-gray-600">
                            <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>A thoughtful cover letter increases your chances of being considered.
                        </p>
                    </div>

                    <!-- Resume Upload -->
                    <div class="mb-8">
                        <label for="cv" class="block text-lg font-bold text-gray-900 mb-3">
                            <i class="fas fa-file-upload text-blue-600 mr-2"></i>Curriculum Vitae (CV) <span class="text-red-500">*</span>
                        </label>
                        
                        <div class="file-upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all duration-300" id="cvUploadArea">
                            <div class="mb-4">
                                <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-4 inline-block"></i>
                            </div>
                            <p class="text-lg font-semibold text-gray-900 mb-2">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-600">PDF, DOC, or DOCX files only ‚Ä¢ Max 5MB</p>
                        </div>

                        <input type="file" id="cv" name="cv" accept=".pdf,.doc,.docx" class="hidden" required>
                        
                        <div class="file-preview hidden mt-4" id="filePreview">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 flex items-center justify-between">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-file text-3xl text-blue-600 mr-4" id="fileIcon"></i>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-900" id="fileName"></p>
                                        <p class="text-sm text-gray-600">Ready to submit</p>
                                    </div>
                                </div>
                                <button type="button" onclick="removeFile()" class="ml-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                    <i class="fas fa-trash mr-2"></i>Remove
                                </button>
                            </div>
                        </div>

                        <p class="mt-3 text-sm text-gray-600">
                            <i class="fas fa-paperclip text-blue-600 mr-1"></i>Your CV will be reviewed along with your resume from your profile.
                        </p>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                        <a href="{{ url_for('jobs.job_detail', job_id=job.id) }}" 
                           class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-900 px-6 py-3 rounded-lg font-semibold transition-all duration-300 text-center inline-flex items-center justify-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Job
                        </a>
                        <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg inline-flex items-center justify-center" id="submitBtn">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Info Card -->
        <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-md p-8 border border-blue-200">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-2xl mr-4 mt-1 flex-shrink-0"></i>
                <div>
                    <h4 class="text-lg font-bold text-gray-900 mb-2">After You Apply</h4>
                    <p class="text-gray-700">
                        You can track your application status, view feedback, and communicate with the employer through your <a href="{{ url_for('dashboard.job_seeker') }}" class="text-blue-600 hover:text-blue-800 font-semibold">job seeker dashboard</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant -->
<div class="ai-assistant-container" id="aiAssistantContainer">
    <div class="ai-circle" id="aiCircle" title="Click for AI assistance">ü§ñ</div>
</div>


<script>
    // File upload handling
    const cvUploadArea = document.getElementById('cvUploadArea');
    const cvInput = document.getElementById('cv');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileIcon = document.getElementById('fileIcon');

    // Click to upload
    cvUploadArea.addEventListener('click', () => {
        cvInput.click();
    });

    // File selection
    cvInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            displayFile(file);
        }
    });

    // Drag and drop
    cvUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        cvUploadArea.classList.add('border-blue-500', 'bg-blue-50');
    });

    cvUploadArea.addEventListener('dragleave', () => {
        cvUploadArea.classList.remove('border-blue-500', 'bg-blue-50');
    });

    cvUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        cvUploadArea.classList.remove('border-blue-500', 'bg-blue-50');
        const file = e.dataTransfer.files[0];
        if (file && isValidFile(file)) {
            cvInput.files = e.dataTransfer.files;
            displayFile(file);
        } else {
            showError('Please upload a valid PDF, DOC, or DOCX file.');
        }
    });

    function displayFile(file) {
        fileName.textContent = file.name;
        
        // Set icon based on file type
        if (file.type === 'application/pdf') {
            fileIcon.className = 'fas fa-file-pdf text-red-500';
        } else if (file.type === 'application/msword' || 
                   file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
            fileIcon.className = 'fas fa-file-word text-blue-600';
        } else {
            fileIcon.className = 'fas fa-file text-blue-600';
        }
        
        filePreview.classList.remove('hidden');
        cvUploadArea.style.display = 'none';
    }

    function removeFile() {
        cvInput.value = '';
        filePreview.classList.add('hidden');
        cvUploadArea.style.display = 'block';
    }

    function isValidFile(file) {
        const validTypes = ['application/pdf', 'application/msword', 
                          'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const validExtensions = ['.pdf', '.doc', '.docx'];
        const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        
        return validTypes.includes(file.type) || validExtensions.includes(extension);
    }

    // Form submission
    document.getElementById('applicationForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const coverLetter = document.getElementById('cover_letter').value.trim();
        const cvFile = document.getElementById('cv').files[0];

        // Validation
        if (!coverLetter) {
            showError('Please write a cover letter.');
            return;
        }

        if (!cvFile) {
            showError('Please upload your CV.');
            return;
        }

        if (!isValidFile(cvFile)) {
            showError('Please upload a valid PDF, DOC, or DOCX file.');
            return;
        }

        // Submit
        const formData = new FormData();
        formData.append('cover_letter', coverLetter);
        formData.append('cv', cvFile);

        // Add CSRF token to FormData
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
        if (csrfToken) {
            formData.append('csrf_token', csrfToken);
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Submitting...';

        try {
            const response = await fetch(e.target.action, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                showSuccess('Application submitted successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = '{{ url_for("jobs.job_detail", job_id=job.id) }}';
                }, 2000);
            } else {
                const data = await response.json();
                showError(data.error || 'Failed to submit application. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Submit Application';
            }
        } catch (error) {
            showError('Network error. Please check your connection and try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Submit Application';
        }
    });

    function showSuccess(message) {
        const successMsg = document.getElementById('successMessage');
        document.getElementById('successText').textContent = message;
        successMsg.classList.remove('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
        window.scrollTo(0, 0);
    }

    function showError(message) {
        const errorMsg = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorMsg.classList.remove('hidden');
        document.getElementById('successMessage').classList.add('hidden');
        window.scrollTo(0, 0);
    }

    // Language preference for AI responses
    let aiLanguage = 'English'; // Default language

    function setAILanguage(lang) {
        aiLanguage = lang;
        // Update button states
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // Initialize AI Assistant
    document.addEventListener('DOMContentLoaded', () => {
        initializeAIAssistant();
    });

    function initializeAIAssistant() {
        const aiCircle = document.getElementById('aiCircle');
        aiCircle.addEventListener('click', showAIMenu);
    }

    function showAIMenu() {
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) {
            existingBubble.remove();
            return;
        }

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble';
        bubble.innerHTML = `
            <div class="ai-bubble-title">
                <span>‚ú® AI Application Assistant</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                <p style="margin: 0 0 12px 0;">How can I help you with your job application?</p>
                
                <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                    <button class="language-btn ${aiLanguage === 'English' ? 'active' : ''}" onclick="setAILanguage('English')">
                        EN
                    </button>
                    <button class="language-btn ${aiLanguage === 'Tagalog' ? 'active' : ''}" onclick="setAILanguage('Tagalog')">
                        TL
                    </button>
                    <button class="language-btn ${aiLanguage === 'Bicol' ? 'active' : ''}" onclick="setAILanguage('Bicol')">
                        BL
                    </button>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="ai-action-btn primary" onclick="improveCoverLetter()">
                        <i class="fas fa-pen"></i> Improve Cover Letter
                    </button>
                    <button class="ai-action-btn" onclick="getApplicationTips()">
                        <i class="fas fa-lightbulb"></i> Application Tips
                    </button>
                    <button class="ai-action-btn" onclick="reviewApplication()">
                        <i class="fas fa-check-circle"></i> Review Application
                    </button>
                </div>
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, document.getElementById('aiCircle'));
    }

    function improveCoverLetter() {
        const aiCircle = document.getElementById('aiCircle');
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) existingBubble.remove();

        const coverLetter = document.getElementById('cover_letter').value.trim();
        
        if (!coverLetter) {
            showAIError('Please write a cover letter first to get improvements.');
            return;
        }

        aiCircle.classList.add('thinking');

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble';
        bubble.innerHTML = `
            <div class="ai-bubble-title">
                <span>‚úèÔ∏è Improving Cover Letter</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                <p style="margin: 0; color: #999;">Analyzing and improving your cover letter...</p>
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, aiCircle);

        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

        fetch('{{ url_for("jobs.improve_application") }}', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ csrf_token: csrfToken, cover_letter: coverLetter, job_title: '{{ job.title }}', language: aiLanguage })
        })
        .then(response => response.json())
        .then(data => {
            aiCircle.classList.remove('thinking');
            if (data.status === 'success') {
                displayAIResponse(data.improvements, 'improvements');
            } else {
                showAIError('Unable to improve cover letter. Please try again.');
            }
        })
        .catch(error => {
            aiCircle.classList.remove('thinking');
            showAIError('Error: ' + error.message);
        });
    }

    function getApplicationTips() {
        const aiCircle = document.getElementById('aiCircle');
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) existingBubble.remove();

        aiCircle.classList.add('thinking');

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble';
        bubble.innerHTML = `
            <div class="ai-bubble-title">
                <span>üí° Getting Tips</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                <p style="margin: 0; color: #999;">Generating personalized tips...</p>
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, aiCircle);

        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

        fetch('{{ url_for("jobs.application_tips") }}', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ csrf_token: csrfToken, job_title: '{{ job.title }}', job_description: '{{ job.description }}', language: aiLanguage })
        })
        .then(response => response.json())
        .then(data => {
            aiCircle.classList.remove('thinking');
            if (data.status === 'success') {
                displayAIResponse(data.tips, 'tips');
            } else {
                showAIError('Unable to generate tips. Please try again.');
            }
        })
        .catch(error => {
            aiCircle.classList.remove('thinking');
            showAIError('Error: ' + error.message);
        });
    }

    function reviewApplication() {
        const aiCircle = document.getElementById('aiCircle');
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) existingBubble.remove();

        const coverLetter = document.getElementById('cover_letter').value.trim();
        const cvFile = document.getElementById('cv').files[0];

        if (!coverLetter || !cvFile) {
            showAIError('Please complete your application (cover letter and CV) before review.');
            return;
        }

        aiCircle.classList.add('thinking');

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble';
        bubble.innerHTML = `
            <div class="ai-bubble-title">
                <span>üìã Reviewing Application</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                <p style="margin: 0; color: #999;">Reviewing your complete application...</p>
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, aiCircle);

        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

        fetch('{{ url_for("jobs.review_application") }}', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ csrf_token: csrfToken, cover_letter: coverLetter, cv_filename: cvFile.name, job_title: '{{ job.title }}', language: aiLanguage })
        })
        .then(response => response.json())
        .then(data => {
            aiCircle.classList.remove('thinking');
            if (data.status === 'success') {
                displayAIResponse(data.review, 'review');
            } else {
                showAIError('Unable to review application. Please try again.');
            }
        })
        .catch(error => {
            aiCircle.classList.remove('thinking');
            showAIError('Error: ' + error.message);
        });
    }

    function displayAIResponse(response, type) {
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) existingBubble.remove();

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble';
        bubble.innerHTML = `
            <div class="ai-bubble-title">
                <span>‚ú® AI Suggestions</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                ${typeof response === 'string' ? `<p style="margin: 0; white-space: pre-wrap;">${escapeHtml(response)}</p>` : formatResponse(response, type)}
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, document.getElementById('aiCircle'));
    }

    function formatResponse(response, type) {
        if (Array.isArray(response)) {
            return `<ul class="ai-suggestion-list">${response.map((item, idx) => `<li key="${idx}">${escapeHtml(item)}</li>`).join('')}</ul>`;
        }
        return `<p style="margin: 0; white-space: pre-wrap;">${escapeHtml(JSON.stringify(response, null, 2))}</p>`;
    }

    function showAIError(error) {
        const existingBubble = document.querySelector('.ai-bubble');
        if (existingBubble) existingBubble.remove();

        const bubble = document.createElement('div');
        bubble.className = 'ai-bubble error';
        bubble.innerHTML = `
            <div class="ai-bubble-title" style="color: #ff6b6b;">
                <span>‚ö†Ô∏è Error</span>
                <button class="ai-close-btn" onclick="this.closest('.ai-bubble').remove()">‚úï</button>
            </div>
            <div class="ai-bubble-content">
                <p style="margin: 0; color: #ff6b6b;">${escapeHtml(error)}</p>
            </div>
        `;
        document.getElementById('aiAssistantContainer').insertBefore(bubble, document.getElementById('aiCircle'));
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Hide the chat button and modal when page loads
    window.addEventListener('load', function() {
        const chatButton = document.querySelector('.fixed.bottom-6.right-6.z-50');
        const chatModal = document.getElementById('chat-modal');
        if (chatButton) chatButton.style.display = 'none';
        if (chatModal) chatModal.style.display = 'none';
    });
</script>
{% endblock %}
