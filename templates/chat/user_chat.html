{% extends "base.html" %}

{% block title %}User Chat{% endblock %}

{% block content %}
<style>
    /* Hide the base.html chat elements on this page */
    .fixed.bottom-6.right-6.z-50 {
        display: none !important;
    }

    #chat-modal {
        display: none !important;
    }

    /* AI Bubble Styles */
    .ai-bubble {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 40;
    }

    .ai-bubble-button {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        color: white;
    }

    .ai-bubble-button:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
    }

    .ai-popup {
        position: fixed;
        bottom: 9rem;
        right: 1.5rem;
        width: 420px;
        max-height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 41;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .ai-popup.show {
        display: flex;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-popup-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .ai-popup-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    .ai-commands {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .ai-command-btn {
        background: #f0f4ff;
        border: 2px solid #e0e7ff;
        border-radius: 12px;
        padding: 12px 16px;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        font-weight: 500;
        color: #2d3748;
    }

    .ai-command-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateX(4px);
    }

    .ai-popup-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
    <!-- AI Bubble -->
    <div class="ai-bubble">
        <button class="ai-bubble-button" id="ai-bubble-btn" title="Chat Assistant">
            <span style="font-size: 28px;">âœ¨</span>
        </button>
        <div class="ai-popup" id="ai-popup">
            <div class="ai-popup-header">
                <div class="flex items-center gap-2">
                    <span style="font-size: 20px;">ðŸ¤–</span>
                    <span class="font-bold" id="ai-header-text">Chat Assistant</span>
                </div>
                <button class="ai-popup-close" id="ai-popup-close">
                    <span style="font-size: 24px;">âœ•</span>
                </button>
            </div>
            <div class="ai-popup-body">
                <p class="text-gray-700 font-semibold mb-4" id="ai-helper-text">Quick chat help</p>
                <div class="ai-commands">
                    <button class="ai-command-btn" onclick="insertUserPrompt('Hello! How are you?')">
                        <span style="font-size: 16px; margin-right: 8px;">ðŸ‘‹</span>
                        <span id="btn-greeting">Send greeting</span>
                    </button>
                    <button class="ai-command-btn" onclick="insertUserPrompt('Can you help me?')">
                        <span style="font-size: 16px; margin-right: 8px;">ðŸ™‹</span>
                        <span id="btn-help">Ask for help</span>
                    </button>
                    <button class="ai-command-btn" onclick="insertUserPrompt('Tell me more about your services')">
                        <span style="font-size: 16px; margin-right: 8px;">ðŸ“‹</span>
                        <span id="btn-services">Ask about services</span>
                    </button>
                    <button class="ai-command-btn" onclick="insertUserPrompt('What are your rates?')">
                        <span style="font-size: 16px; margin-right: 8px;">ðŸ’°</span>
                        <span id="btn-rates">Ask about rates</span>
                    </button>
                    <button class="ai-command-btn" onclick="clearUserChat()">
                        <span style="font-size: 16px; margin-right: 8px;">ðŸ”„</span>
                        <span id="btn-clear">Clear messages</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="max-w-4xl mx-auto">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="javascript:history.back()" class="inline-flex items-center text-blue-600 hover:text-blue-700 font-semibold transition-colors">
                <i class="fas fa-chevron-left mr-2"></i>Back
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Conversations List (Left Sidebar) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-comments mr-2"></i>Messages
                        </h2>
                    </div>
                    <div id="conversations-list" class="divide-y max-h-96 overflow-y-auto">
                        <!-- Conversations will be loaded here -->
                        <div class="p-4 text-gray-500 text-center text-sm">
                            <i class="fas fa-inbox text-gray-300 text-2xl mb-2 block"></i>
                            No conversations yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area (Main) -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-96 lg:h-auto">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 flex items-center justify-between">
                        <div class="flex items-center">
                            {% if recipient %}
                            <div>
                                <h2 class="text-xl font-bold">{{ recipient.username }}</h2>
                                <p class="text-blue-100 text-sm">
                                    {% if recipient.role == 'business_owner' %}
                                        <i class="fas fa-store mr-1"></i>Business Owner
                                    {% elif recipient.role == 'job_seeker' %}
                                        <i class="fas fa-briefcase mr-1"></i>Job Seeker
                                    {% else %}
                                        {{ recipient.role }}
                                    {% endif %}
                                </p>
                            </div>
                            {% elif recipient_id %}
                            <div>
                                <h2 class="text-xl font-bold" id="recipient-name-header">Loading...</h2>
                                <p class="text-blue-100 text-sm" id="recipient-role-header"></p>
                            </div>
                            {% else %}
                            <h2 class="text-xl font-bold">
                                <i class="fas fa-comments mr-2"></i>Select a conversation
                            </h2>
                            {% endif %}
                        </div>
                        <button onclick="loadConversations()" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded transition-colors">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>

                    <!-- Messages Area -->
                    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                        {% if recipient or recipient_id %}
                        <!-- Messages will be loaded here -->
                        {% else %}
                        <div class="flex items-center justify-center h-full">
                            <p class="text-gray-500 text-center">
                                <i class="fas fa-comments text-gray-300 text-4xl mb-2 block"></i>
                                Select a conversation to start messaging
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Message Input -->
                    {% if recipient or recipient_id %}
                    <div class="border-t p-4 bg-white">
                        <form id="message-form" class="flex gap-2" onsubmit="sendMessage(event)">
                            <input 
                                type="text" 
                                id="message-input" 
                                class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                placeholder="Type your message..." 
                                required
                            >
                            <button 
                                type="submit" 
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center"
                            >
                                <i class="fas fa-paper-plane mr-2"></i>Send
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const userChatTranslations = {
        en: {
            'ai-header-text': 'Chat Assistant',
            'ai-helper-text': 'Quick chat help',
            'btn-greeting': 'Send greeting',
            'btn-help': 'Ask for help',
            'btn-services': 'Ask about services',
            'btn-rates': 'Ask about rates',
            'btn-clear': 'Clear messages'
        },
        tl: {
            'ai-header-text': 'Chat Assistant',
            'ai-helper-text': 'Mabilis na tulong sa chat',
            'btn-greeting': 'Magpadala ng pagsalubong',
            'btn-help': 'Hilingin ang tulong',
            'btn-services': 'Magtanong tungkol sa mga serbisyo',
            'btn-rates': 'Magtanong tungkol sa mga rate',
            'btn-clear': 'Limasin ang mga mensahe'
        },
        bcl: {
            'ai-header-text': 'Chat Assistant',
            'ai-helper-text': 'Bilogan na tulong sa chat',
            'btn-greeting': 'Magpadala ng pagsalubong',
            'btn-help': 'Hilingin an tulong',
            'btn-services': 'Magtanong tungkol sa mga serbisyo',
            'btn-rates': 'Magtanong tungkol sa mga rate',
            'btn-clear': 'Limasin an mga mensahe'
        }
    };

    function updateUserChatLanguage() {
        const currentLang = localStorage.getItem('language') || 'en';
        const translation = userChatTranslations[currentLang] || userChatTranslations.en;
        
        for (const [key, value] of Object.entries(translation)) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
            }
        }
    }

    function insertUserPrompt(text) {
        const input = document.getElementById('message-input');
        if (input) {
            input.value = text;
            input.focus();
        }
    }

    function clearUserChat() {
        const container = document.getElementById('messages-container');
        if (container && confirm('Are you sure you want to clear this conversation?')) {
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <p class="text-gray-500 text-center">
                        <i class="fas fa-comments text-gray-300 text-4xl mb-2 block"></i>
                        Conversation cleared. Start fresh!
                    </p>
                </div>
            `;
        }
    }

    const recipientId = '{{ recipient_id if recipient_id else (recipient.id if recipient else "") }}';
    const recipientName = '{{ recipient.username if recipient else "User" }}';
    const recipientRole = '{{ recipient.role if recipient else "" }}';

    // Load conversations on page load
    document.addEventListener('DOMContentLoaded', () => {
        updateUserChatLanguage();
        window.addEventListener('languageChange', updateUserChatLanguage);
        
        // AI Bubble Toggle
        const aiBtn = document.getElementById('ai-bubble-btn');
        const aiPopup = document.getElementById('ai-popup');
        const aiClose = document.getElementById('ai-popup-close');
        
        if (aiBtn) {
            aiBtn.addEventListener('click', () => {
                aiPopup.classList.toggle('show');
            });
        }
        
        if (aiClose) {
            aiClose.addEventListener('click', () => {
                aiPopup.classList.remove('show');
            });
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.ai-bubble')) {
                aiPopup.classList.remove('show');
            }
        });
        
        loadConversations();
        if (recipientId) {
            loadRecipientInfo();
            loadMessages();
            // Auto-refresh messages every 2 seconds
            setInterval(loadMessages, 2000);
        }
    });

    async function loadRecipientInfo() {
        if (!recipientId || recipientName !== 'Loading...') return;
        try {
            const response = await fetch(`/api/users/${recipientId}`, {
                headers: {'Accept': 'application/json'}
            });
            if (response.ok) {
                const data = await response.json();
                if (data.user) {
                    document.getElementById('recipient-name-header').textContent = data.user.username;
                    const roleText = data.user.role === 'business_owner' ? 'Business Owner' : 
                                   data.user.role === 'job_seeker' ? 'Job Seeker' : data.user.role;
                    const roleIcon = data.user.role === 'business_owner' ? 'fa-store' : 'fa-briefcase';
                    document.getElementById('recipient-role-header').innerHTML = `<i class="fas ${roleIcon} mr-1"></i>${roleText}`;
                }
            }
        } catch (error) {
            console.error('Error loading recipient info:', error);
        }
    }

    async function loadConversations() {
        try {
            const response = await fetch('{{ url_for("chat.get_conversations_list") }}');
            const data = await response.json();
            const conversationsList = document.getElementById('conversations-list');
            
            if (data.conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="p-4 text-gray-500 text-center text-sm">
                        <i class="fas fa-inbox text-gray-300 text-2xl mb-2 block"></i>
                        No conversations yet
                    </div>
                `;
                return;
            }
            
            conversationsList.innerHTML = data.conversations.map(conv => `
                <a href="{{ url_for('chat.user_chat_view') }}?recipient_id=${conv.user.id}"
                   class="block p-4 hover:bg-gray-100 transition-colors border-l-4 ${conv.user.id === recipientId ? 'border-blue-600 bg-blue-50' : 'border-transparent'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${conv.user.username}</h3>
                            <p class="text-sm text-gray-500">${new Date(conv.last_message).toLocaleDateString()}</p>
                        </div>
                        ${conv.unread_count > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">${conv.unread_count}</span>` : ''}
                    </div>
                </a>
            `).join('');
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    async function loadMessages() {
        if (!recipientId) return;

        try {
            const response = await fetch(`{{ url_for('chat.get_conversation', recipient_id='__RECIPIENT_ID__') }}`.replace('__RECIPIENT_ID__', recipientId));
            const data = await response.json();
            const container = document.getElementById('messages-container');
            
            if (data.messages.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-gray-500 text-center">
                            <i class="fas fa-comments text-gray-300 text-4xl mb-2 block"></i>
                            No messages yet. Start the conversation!
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.messages.map(msg => `
                <div class="flex ${msg.sender_id === '{{ current_user.id }}' ? 'justify-end' : 'justify-start'}">
                    <div class="${msg.sender_id === '{{ current_user.id }}' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'} px-4 py-2 rounded-lg max-w-xs break-words">
                        <p>${msg.text}</p>
                        <p class="text-xs ${msg.sender_id === '{{ current_user.id }}' ? 'text-blue-100' : 'text-gray-600'} mt-1">
                            ${new Date(msg.timestamp).toLocaleTimeString()}
                        </p>
                    </div>
                </div>
            `).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    async function sendMessage(e) {
        e.preventDefault();
        
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message || !recipientId) {
            console.error('Missing message or recipientId');
            return;
        }

        try {
            // Get CSRF token from meta tag (not input field)
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const endpoint = '{{ url_for("chat.send_user_message") }}';
            
            console.log('Sending message to:', recipientId);
            console.log('CSRF Token present:', !!csrfToken);
            console.log('CSRF Token value:', csrfToken ? csrfToken.substring(0, 20) + '...' : 'NOT FOUND');
            console.log('Endpoint URL:', endpoint);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || ''
                },
                body: JSON.stringify({
                    recipient_id: recipientId,
                    message: message
                })
            });

            console.log('Response status:', response.status);
            
            // Get response text first to check if it's HTML or JSON
            const responseText = await response.text();
            console.log('Response text (first 200 chars):', responseText.substring(0, 200));
            
            try {
                const data = JSON.parse(responseText);
                console.log('Response data:', data);
                
                if (data.success) {
                    input.value = '';
                    loadMessages();
                } else {
                    alert('Error sending message: ' + (data.error || 'Unknown error'));
                }
            } catch (parseError) {
                console.error('Failed to parse JSON. Response was HTML (likely error page)');
                alert('Error: API endpoint not found. Check console for details.');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message: ' + error.message);
        }
    }
</script>
{% endblock %}
